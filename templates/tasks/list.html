{% extends "base.html" %}

{% block title %}Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù…{% endblock %}

{% block content %}
<div class="tasks-container">
  <div class="tasks-card">
    <div class="header-row" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:22px;">
      <h2 style="margin:0;">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù…</h2>
      {% if request.user.userprofile.role.name == 'admin' %}
      <a href="{% url 'add_task' %}" class="add-task-btn">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</a>
      {% endif %}
    </div>
    <div class="table-responsive">
      <table class="tasks-table">
        <thead>
          <tr>
            <th>Ù…</th>
            <th>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©</th>
            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
            <th>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚</th>
            <th>ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody>
          {% for task in all_tasks %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ task.title }}</td>
            <td>{{ task.due_date|date:"Y-m-d"|default:"â€”" }}</td>
            <td>
              {% if task.status == 'pending' %}
                <span class="badge badge-warning">Ù…Ø¹Ù„Ù‚Ø©</span>
              {% elif task.status == 'completed' %}
                <span class="badge badge-success">Ù…ÙƒØªÙ…Ù„Ø©</span>
              {% elif task.status == 'overdue' %}
                <span class="badge badge-danger">Ù…ØªØ£Ø®Ø±Ø©</span>
              {% endif %}
            </td>
            <td>
              {% if task.assigned_to %}
                {{ task.assigned_to.get_full_name|default:task.assigned_to.username }}
              {% else %}
                â€”
              {% endif %}
            </td>
            <td>
              {% if task.file_url %}
                <a href="{{ task.file_url }}" target="_blank" class="btn btn-sm btn-outline-info">ğŸ“ Ø¹Ø±Ø¶</a>
              {% else %}
                <span class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>
              {% endif %}
            </td>
            <td>
              <select class="form-select update-status" data-task-id="{{ task.id }}">
                <option value="pending" {% if task.status == 'pending' %}selected{% endif %}>Ù…Ø¹Ù„Ù‚Ø©</option>
                <option value="completed" {% if task.status == 'completed' %}selected{% endif %}>Ù…ÙƒØªÙ…Ù„Ø©</option>
                <option value="overdue" {% if task.status == 'overdue' %}selected{% endif %}>Ù…ØªØ£Ø®Ø±Ø©</option>
              </select>
            </td>
            <td>
              {% if request.user.userprofile.role.name == 'admin' %}
                <button class="btn btn-sm btn-outline-danger delete-task-btn" data-task-id="{{ task.id }}">ğŸ—‘ Ø­Ø°Ù</button>
              {% else %}
                <span class="text-muted">â€”</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="empty-row">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…Ø³Ø¬Ù„Ø©.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- âœ… Ø³ÙƒØ±Ø¨Øª ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ­Ø°Ù -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const csrfToken = '{{ csrf_token }}';

    // âœ… ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ø©
    document.querySelectorAll('.update-status').forEach(function (select) {
      select.addEventListener('change', function () {
        const taskId = this.dataset.taskId;
        const newStatus = this.value;

        Swal.fire({
          title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØºÙŠÙŠØ±',
          text: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Ù†Ø¹Ù…ØŒ ØºÙŠÙ‘Ø±',
          cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
          confirmButtonColor: '#5DE6A9',
          cancelButtonColor: '#999',
          customClass: { popup: 'swal2-rounded' }
        }).then((result) => {
          if (result.isConfirmed) {
            fetch(`/tasks/update-status/${taskId}/`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
              },
              body: JSON.stringify({ status: newStatus })
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                Swal.fire({
                  icon: 'success',
                  title: 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«',
                  text: 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­',
                  confirmButtonColor: '#5DE6A9',
                  customClass: { popup: 'swal2-rounded' }
                }).then(() => location.reload());
              } else {
                Swal.fire({
                  icon: 'error',
                  title: 'ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«',
                  text: data.error || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
                  confirmButtonColor: '#ff7675',
                  customClass: { popup: 'swal2-rounded' }
                });
              }
            })
            .catch(err => {
              Swal.fire({
                icon: 'error',
                title: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„',
                text: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…',
                confirmButtonColor: '#ff7675',
                customClass: { popup: 'swal2-rounded' }
              });
              console.error(err);
            });
          }
        });
      });
    });

    // âœ… Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©
    document.querySelectorAll('.delete-task-btn').forEach(function (btn) {
      btn.addEventListener('click', function () {
        const taskId = this.dataset.taskId;
        Swal.fire({
          title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù',
          text: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
          cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
          confirmButtonColor: '#ff7675',
          cancelButtonColor: '#999',
          customClass: { popup: 'swal2-rounded' }
        }).then((result) => {
          if (result.isConfirmed) {
            fetch(`/tasks/delete/${taskId}/`, {
              method: 'POST',
              headers: {
                'X-CSRFToken': csrfToken
              }
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                Swal.fire({
                  icon: 'success',
                  title: 'ØªÙ… Ø§Ù„Ø­Ø°Ù',
                  text: 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­',
                  confirmButtonColor: '#5DE6A9',
                  customClass: { popup: 'swal2-rounded' }
                }).then(() => location.reload());
              } else {
                Swal.fire({
                  icon: 'error',
                  title: 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù',
                  text: data.error || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
                  confirmButtonColor: '#ff7675',
                  customClass: { popup: 'swal2-rounded' }
                });
              }
            })
            .catch(err => {
              Swal.fire({
                icon: 'error',
                title: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„',
                text: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù',
                confirmButtonColor: '#ff7675',
                customClass: { popup: 'swal2-rounded' }
              });
              console.error(err);
            });
          }
        });
      });
    });
  });
</script>
{% endblock %}

{% block extra_css %}
<style>
body {
  background-color: #F0F4F8;
  font-family: 'Tajawal', sans-serif;
}
.tasks-container {
  display: flex;
  justify-content: center;
  padding-top: 80px;
  padding-bottom: 40px;
}
.tasks-card {
  background: #ffffff;
  padding: 30px 25px;
  border-radius: 20px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
  width: 100%;
  max-width: 1100px;
  color: #2F4157;
}
.tasks-card h2 {
  text-align: center;
  margin-bottom: 25px;
  font-size: 1.4rem;
}
.add-task-btn {
  background: linear-gradient(135deg, #2EC6F3, #5DE6A9);
  color: white;
  padding: 8px 16px;
  border-radius: 8px;
  text-decoration: none;
  font-size: 1rem;
  font-weight: 500;
  box-shadow: 0 2px 8px #2ec6f32a;
  transition: opacity 0.2s, background 0.3s;
}
.add-task-btn:hover {
  opacity: 0.9;
}
.tasks-table {
  width: 100%;
  border-collapse: collapse;
}
.tasks-table th,
.tasks-table td {
  padding: 12px;
  text-align: center;
  border-bottom: 1px solid #e0e6ed;
}
.tasks-table thead {
  background-color: #EAF7FA;
}
.tasks-table tbody tr:hover {
  background-color: #f5f9fc;
}
.badge {
  padding: 5px 10px;
  border-radius: 8px;
  font-size: 0.85rem;
  font-weight: 600;
  display: inline-block;
}
.badge-warning {
  background-color: #ffeaa7;
  color: #555;
}
.badge-success {
  background-color: #55efc4;
  color: #2d3436;
}
.badge-danger {
  background-color: #ff7675;
  color: #fff;
}
.empty-row {
  text-align: center;
  color: #777;
  font-size: 0.95rem;
}
.form-select {
  padding: 6px 10px;
  font-size: 0.85rem;
  border-radius: 6px;
  border: 1px solid #ccc;
}
</style>
{% endblock %}
